<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload MemoTape File</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo/memotape-logo.png') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'memo-green': '#10B981', 
                        'memo-light': '#E0F2F1', 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        html {
            scroll-padding-top: 64px; 
        }
        
        body {
            cursor: none;
        }
        #custom-cursor {
            position: fixed;
            width: 1rem;
            height: 1rem;
            background-color: #10B981;
            border-radius: 9999px;
            pointer-events: none;
            z-index: 9999;
            mix-blend-mode: difference;
            transition: transform 0.2s ease-out, background-color 0.2s ease-out; 
            transform: translate(-50%, -50%) scale(1);
        }
        @media (max-width: 768px) {
            #custom-cursor { display: none !important; }
            body { cursor: default; }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
    <div id="custom-cursor"></div>

    <nav class="fixed top-0 left-0 w-full bg-white shadow-lg z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0 flex items-center">
                    <a href="{{ url_for('index') }}" class="flex items-center">
                        <img src="{{ url_for('static', filename='logo/memotape-logo.png') }}" 
                             alt="MemoTape Logo" 
                             class="h-8 w-8 object-contain mr-2 rounded-full shadow-md"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                        <span style="display:none;" class="text-memo-green font-bold text-2xl">MT</span>
                        <span class="text-xl font-extrabold text-gray-900 tracking-tight">MemoTape Reader</span>
                    </a>
                </div>
                <a href="{{ url_for('index') }}" class="text-gray-600 hover:text-memo-green font-medium transition duration-150 hidden sm:block">
                    &larr; Back to Home
                </a>
            </div>
        </div>
    </nav>

    <main class="min-h-screen pt-24 pb-12 flex items-start justify-center">
        <div class="max-w-xl mx-auto w-full px-4 sm:px-6 lg:px-8">
            
            <div class="bg-white p-8 md:p-12 rounded-xl shadow-2xl border-t-4 border-memo-green space-y-8 text-center">
                <h1 class="text-4xl font-extrabold text-gray-900 mb-4">
                    Load a MemoTape
                </h1>
                <p class="text-gray-500">
                    Select your local <b>.memo</b> file to view the story and media.
                </p>
                
                <div class="pt-4 border-t border-gray-100">
                    <label for="memo-file" class="block text-lg font-medium text-gray-700 mb-2">
                        Upload .memo file:
                    </label>
                    <input type="file" id="memo-file" accept=".memo" 
                           class="w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-full file:border-0 file:text-base file:font-semibold file:bg-memo-light file:text-memo-green hover:file:bg-memo-green hover:file:text-white transition duration-200 focus:outline-none focus:ring-2 focus:ring-memo-green focus:ring-offset-2 rounded-lg p-2 border border-gray-300">
                </div>

                <div id="status-message" class="text-gray-600 italic mt-4 min-h-[1.5rem]">
                    Please select a file.
                </div>
                
                <button id="view-story-button" disabled
                        class="w-full py-3 bg-gray-300 text-gray-500 text-xl font-bold rounded-xl shadow-md transition duration-300 cursor-not-allowed">
                    View Story
                </button>
            </div>

        </div>
    </main>

    <footer class="bg-gray-800 text-white mt-12">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-xs text-gray-500 mt-1">
                Design and Development by <a href="#" class="text-memo-green hover:underline">Vedant Desai</a>
            </p>
        </div>
    </footer>

    <script>
        const memoFileInput = document.getElementById('memo-file');
        const viewStoryButton = document.getElementById('view-story-button');
        const statusMessage = document.getElementById('status-message');

        function updateButtonState(isLoading = false) {
            if (isLoading) {
                viewStoryButton.textContent = 'Processing...';
                viewStoryButton.disabled = true;
                viewStoryButton.classList.remove('bg-memo-green', 'hover:bg-green-600');
                viewStoryButton.classList.add('bg-gray-400', 'cursor-wait');
            } else if (memoFileInput.files.length > 0) {
                viewStoryButton.textContent = 'View Story';
                viewStoryButton.disabled = false;
                viewStoryButton.classList.add('bg-memo-green', 'hover:bg-green-600');
                viewStoryButton.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed', 'bg-gray-400', 'cursor-wait');
            } else {
                viewStoryButton.textContent = 'View Story';
                viewStoryButton.disabled = true;
                viewStoryButton.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                viewStoryButton.classList.remove('bg-memo-green', 'hover:bg-green-600', 'bg-gray-400', 'cursor-wait');
            }
        }

        memoFileInput.addEventListener('change', () => {
            updateButtonState();
            statusMessage.textContent = memoFileInput.files.length > 0 ? `File selected: ${memoFileInput.files[0].name}` : 'Please select a file.';
        });

        viewStoryButton.addEventListener('click', readAndRedirect);

        function readAndRedirect() {
            const file = memoFileInput.files[0];
            if (!file) {
                statusMessage.textContent = 'Error: No file selected.';
                statusMessage.classList.add('text-red-500');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.memo')) {
                statusMessage.textContent = 'Error: Invalid file type. Please upload a .memo file.';
                statusMessage.classList.add('text-red-500');
                return;
            }

            updateButtonState(true);
            statusMessage.textContent = 'Reading and validating file...';
            statusMessage.classList.remove('text-red-500');

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const memoContent = JSON.parse(e.target.result);
                    
                    localStorage.setItem('currentMemoTape', JSON.stringify(memoContent));
                    
                    window.location.href = "{{ url_for('display_memotape_story') }}";

                } catch (error) {
                    statusMessage.textContent = 'Error: The file is corrupted or not valid JSON.';
                    statusMessage.classList.add('text-red-500');
                    updateButtonState(false);
                    console.error("Error parsing memo file:", error);
                }
            };

            reader.onerror = function() {
                statusMessage.textContent = 'Error reading file content.';
                statusMessage.classList.add('text-red-500');
                updateButtonState(false);
            };

            reader.readAsText(file);
        }

        const customCursor = document.getElementById('custom-cursor');
        const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

        if (!isTouchDevice) {
            document.addEventListener('mousemove', (e) => {
                customCursor.style.left = `${e.clientX}px`;
                customCursor.style.top = `${e.clientY}px`;

                const target = e.target;
                const isInteractive = target.tagName === 'A' || target.tagName === 'BUTTON' || target.tagName === 'INPUT' || target.closest('label') || target.closest('a') || target.closest('button');

                if (isInteractive) {
                    customCursor.style.transform = 'translate(-50%, -50%) scale(2.2)'; 
                    customCursor.style.backgroundColor = 'white'; 
                } else {
                    customCursor.style.transform = 'translate(-50%, -50%) scale(1)'; 
                    customCursor.style.backgroundColor = '#10B981'; 
                }
            });
        }

        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

    </script>
</body>
</html>